name: Docker Build and Deploy

# Trigger workflow on push to main and develop branches
# Reference: https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#push
on:
  push:
    branches:
      - main
      - develop
    # Ignore changes to documentation and non-code files
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'

# Global environment variables
env:
  # Docker Hub repository name (adjust if needed)
  DOCKER_REPOSITORY: mcpserverkotlin
  # Image name format: username/repository
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/mcpserverkotlin

# Permissions required for this workflow
# Reference: https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token
permissions:
  contents: read

jobs:
  # Job to build and push Docker image to Docker Hub
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    
    # Output the image digest for downstream jobs
    outputs:
      image-digest: ${{ steps.build-push.outputs.digest }}
      image-tags: ${{ steps.meta.outputs.tags }}
      image-version: ${{ steps.meta.outputs.version }}
    
    steps:
      # Step 1: Checkout the repository
      # Reference: https://github.com/actions/checkout
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Step 2: Set up Docker Buildx
      # Docker Buildx is required for advanced Docker build features
      # Reference: https://github.com/docker/setup-buildx-action
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # Step 3: Log in to Docker Hub
      # Uses the configured secrets for authentication
      # Reference: https://github.com/docker/login-action
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      # Step 4: Extract metadata for Docker
      # This step generates tags and labels based on git ref and SHA
      # Reference: https://github.com/docker/metadata-action
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          # Tag strategy:
          # - 'latest' for main branch
          # - 'develop' for develop branch
          # - git short SHA for all branches (tracking)
          # - semantic version if tag is pushed (future-proof)
          tags: |
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=raw,value=develop,enable=${{ github.ref == 'refs/heads/develop' }}
            type=sha,prefix={{branch}}-,format=short
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
          labels: |
            org.opencontainers.image.title=MCP Full-Stack Server
            org.opencontainers.image.description=Kotlin-based MCP server for AI agents
            org.opencontainers.image.vendor=AppToLast
      
      # Step 5: Build and push Docker image
      # Uses the existing Dockerfile at docker/Dockerfile
      # Reference: https://github.com/docker/build-push-action
      - name: Build and push Docker image
        id: build-push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Enable build cache for faster builds
          # Reference: https://docs.docker.com/build/cache/backends/
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # Build arguments (if needed in future)
          build-args: |
            VERSION=${{ steps.meta.outputs.version }}
      
      # Step 6: Display build summary
      - name: Image build summary
        run: |
          echo "## Docker Build Summary :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** \`${{ steps.build-push.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
  
  # Job to trigger Kubernetes deployment update
  # This job creates a signal that Kubernetes can use to pull the new image
  update-kubernetes:
    name: Update Kubernetes Deployment
    needs: build-and-push
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      # Step 1: Checkout repository for deployment scripts
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Step 2: Create deployment signal file
      # This creates a timestamped file that can trigger Kubernetes updates
      # Reference: https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#updating-a-deployment
      - name: Create deployment signal
        run: |
          mkdir -p .deployment
          echo "Image: ${{ needs.build-and-push.outputs.image-tags }}" > .deployment/latest-deploy.txt
          echo "Digest: ${{ needs.build-and-push.outputs.image-digest }}" >> .deployment/latest-deploy.txt
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> .deployment/latest-deploy.txt
          echo "Commit: ${{ github.sha }}" >> .deployment/latest-deploy.txt
          echo "Branch: ${{ github.ref_name }}" >> .deployment/latest-deploy.txt
          cat .deployment/latest-deploy.txt
      
      # Step 3: Display Kubernetes update instructions
      # This provides manual update commands since we don't have k8s credentials
      # Note: The current k8s deployment uses apptolast.com/mcp-fullstack-server
      # but this workflow pushes to Docker Hub as $DOCKERHUB_USERNAME/mcpserverkotlin
      - name: Kubernetes update summary
        run: |
          echo "## Kubernetes Deployment Update ☸️" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The Docker image has been successfully pushed to Docker Hub." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note:** If your deployment currently uses a different image registry," >> $GITHUB_STEP_SUMMARY
          echo "> you may need to update \`k8s/deployment.yaml\` to reference the Docker Hub image." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Update Kubernetes Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To update your Kubernetes deployment with the new image, run:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Using digest (recommended for precise tracking)" >> $GITHUB_STEP_SUMMARY
          echo "kubectl set image deployment/mcp-fullstack-server \\" >> $GITHUB_STEP_SUMMARY
          echo "  mcp-server=${{ env.IMAGE_NAME }}@${{ needs.build-and-push.outputs.image-digest }} \\" >> $GITHUB_STEP_SUMMARY
          echo "  -n cyberlab" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Or using tag" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "kubectl set image deployment/mcp-fullstack-server \\" >> $GITHUB_STEP_SUMMARY
            echo "  mcp-server=${{ env.IMAGE_NAME }}:latest \\" >> $GITHUB_STEP_SUMMARY
            echo "  -n cyberlab" >> $GITHUB_STEP_SUMMARY
          else
            echo "kubectl set image deployment/mcp-fullstack-server \\" >> $GITHUB_STEP_SUMMARY
            echo "  mcp-server=${{ env.IMAGE_NAME }}:develop \\" >> $GITHUB_STEP_SUMMARY
            echo "  -n cyberlab" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Verify rollout status" >> $GITHUB_STEP_SUMMARY
          echo "kubectl rollout status deployment/mcp-fullstack-server -n cyberlab" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Alternative: Restart Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If using \`imagePullPolicy: Always\` in your deployment:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "kubectl rollout restart deployment/mcp-fullstack-server -n cyberlab" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      # Step 4: Trigger webhook (optional, for future use)
      # This step is commented out but can be enabled when webhook is configured
      # - name: Trigger deployment webhook
      #   if: env.WEBHOOK_URL != ''
      #   env:
      #     WEBHOOK_URL: ${{ secrets.K8S_WEBHOOK_URL }}
      #   run: |
      #     curl -X POST "$WEBHOOK_URL" \
      #       -H "Content-Type: application/json" \
      #       -d '{
      #         "image": "${{ needs.build-and-push.outputs.image-tags }}",
      #         "digest": "${{ needs.build-and-push.outputs.image-digest }}",
      #         "namespace": "cyberlab",
      #         "deployment": "mcp-fullstack-server"
      #       }'
